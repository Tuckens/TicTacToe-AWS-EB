<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <title>Tic Tac Toe</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        h1 {
            margin-bottom: 20px;
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .game-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            text-align: center;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(3, 120px);
            grid-template-rows: repeat(3, 120px);
            gap: 10px;
            margin: 20px 0;
        }

        .cell {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 10px;
            font-size: 48px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .cell:hover:not(:disabled) {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .cell:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .cell.x { color: #667eea; }
        .cell.o { color: #764ba2; }

        #status { font-size: 1.5em; margin: 20px 0; min-height: 40px; }
        #identity { font-size: 1em; color: #48bb78; margin-bottom: 10px; font-weight: bold; }

        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.3); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #764ba2; }
        input:checked + .slider:before { transform: translateX(26px); }

        .btn-group { display: flex; flex-direction: column; gap: 10px; width: 100%; align-items: center; }

        button#newGame, button#inviteBtn, button#rematchBtn {
            width: 100%; max-width: 250px; border: none; padding: 15px 0;
            font-size: 1.2em; font-weight: bold; border-radius: 50px; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        button#newGame { background: white; color: #667eea; }
        button#inviteBtn { background: #48bb78; color: white; }
        button#rematchBtn { background: #ed8936; color: white; display: none; }

        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
<h1>ðŸŽ® Tic Tac Toe</h1>

<div class="game-container">
    <div id="identity"></div>
    <div id="status">Click "New Game" to start!</div>

    <div class="board" id="board">
        <button class="cell" data-row="0" data-col="0"></button>
        <button class="cell" data-row="0" data-col="1"></button>
        <button class="cell" data-row="0" data-col="2"></button>
        <button class="cell" data-row="1" data-col="0"></button>
        <button class="cell" data-row="1" data-col="1"></button>
        <button class="cell" data-row="1" data-col="2"></button>
        <button class="cell" data-row="2" data-col="0"></button>
        <button class="cell" data-row="2" data-col="1"></button>
        <button class="cell" data-row="2" data-col="2"></button>
    </div>

    <div id="aiControl" style="margin: 10px 0; display: flex; align-items: center; justify-content: center; gap: 10px;">
        <span>Play against AI:</span>
        <label class="switch">
            <input type="checkbox" id="aiToggle" checked>
            <span class="slider"></span>
        </label>
    </div>

    <div class="btn-group">
        <button id="newGame">New Game</button>
        <button id="inviteBtn">Invite Friend</button>
        <button id="rematchBtn">Request Rematch (0/2)</button>
    </div>
</div>

<script>
    const BASE_URL = 'http://tictactoe-env.eba-hir2yshp.eu-central-1.elasticbeanstalk.com';
    const API_URL = `${BASE_URL}/api/game`;

    const sounds = {
        move: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
        win: new Audio('https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3'),
        join: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3')
    };

    function safePlay(sound) {
        sound.play().catch(() => console.log("Sound play blocked until user interaction"));
    }

    let gameId = null;
    let stompClient = null;
    let playerRole = null;
    let opponentJoined = false;
    let currentTurn = 'X';

    const cells = document.querySelectorAll('.cell');
    const statusText = document.getElementById('status');
    const identityText = document.getElementById('identity');
    const rematchBtn = document.getElementById('rematchBtn');
    const aiControl = document.getElementById('aiControl');

    function connectWebSocket(id) {
        const socket = new SockJS(`${BASE_URL}/ws-tictactoe`);
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, () => {
            // Subscribe FIRST so we don't miss the join confirmation
            stompClient.subscribe(`/topic/game/${id}`, (message) => {
                const data = JSON.parse(message.body);

                // This is the trigger that unlocks the "Waiting for friend" screen
                if (data.playerXPresent && data.playerOPresent) {
                    opponentJoined = true;
                }

                currentTurn = data.currentPlayer;
                renderBoard(data.board);
                updateUI(data);
            });

            // Tell the server "I am here" (Works for both X and O)
            stompClient.send(`/app/join/${id}`, {}, JSON.stringify({ player: playerRole }));

        }, (error) => {
            console.error("WebSocket Error: ", error);
            statusText.textContent = "Connection Error. Try refreshing.";
        });
    }

    async function newGame(forceAiOff = false) {
        const aiOn = forceAiOff ? false : document.getElementById('aiToggle').checked;
        try {
            const res = await fetch(`${API_URL}/new?aiMode=${aiOn}`, { method: 'POST' });
            if (!res.ok) throw new Error("Server error");
            const data = await res.json();
            gameId = data.gameId;

            // If AI is on, the "opponent" is technically present immediately
            opponentJoined = aiOn;

            renderBoard(data.board);
            rematchBtn.style.display = 'none';
            statusText.textContent = aiOn ? "Playing against AI..." : "Waiting for friend...";
            enableBoard();
            return true;
        } catch (e) {
            statusText.textContent = "Server Error";
            console.error(e);
            return false;
        }
    }

    async function handleMove(r, c) {
        if (!gameId) return;

        // If we have a playerRole (X or O), we are in a live multiplayer session
        if (playerRole) {
            if (!opponentJoined) {
                statusText.textContent = "Waiting for friend...";
                return;
            }
            if (playerRole !== currentTurn) return;

            // Use WebSockets for live moves
            if (stompClient && stompClient.connected) {
                safePlay(sounds.move);
                stompClient.send(`/app/move/${gameId}`, {}, JSON.stringify({
                    row: parseInt(r),
                    column: parseInt(c),
                    player: playerRole
                }));
            }
            return; // Exit so we don't call the fetch below
        }

        // Standard Local/AI Move (REST API)
        safePlay(sounds.move);
        const res = await fetch(`${API_URL}/${gameId}/move`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ row: r, column: c })
        });
        const data = await res.json();
        renderBoard(data.board);
        updateUI(data);
    }

    function updateUI(data) {
        if (data.status.includes('WON') || data.status === 'DRAW') {
            statusText.textContent = data.status.replace('_', ' ');
            if (data.status.includes('WON')) safePlay(sounds.win);
            disableBoard();
            if (playerRole) {
                rematchBtn.style.display = 'block';
                const readyCount = (data.playerXReady ? 1 : 0) + (data.playerOReady ? 1 : 0);
                rematchBtn.textContent = `Request Rematch (${readyCount}/2)`;
            }
        } else {
            statusText.textContent = opponentJoined ? `${data.currentPlayer}'s turn` : "Waiting for friend...";
        }
    }

    function renderBoard(board) {
        cells.forEach((cell, i) => {
            const val = board[Math.floor(i/3)][i%3];
            cell.textContent = val === ' ' ? '' : val;
            cell.className = `cell ${val.toLowerCase()}`;
            cell.disabled = (val !== ' ');
        });
    }

    function enableBoard() { cells.forEach(c => c.disabled = false); }
    function disableBoard() { cells.forEach(c => c.disabled = true); }

    function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            return navigator.clipboard.writeText(text);
        } else {
            let textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            return new Promise((res, rej) => {
                document.execCommand('copy') ? res() : rej();
                textArea.remove();
            });
        }
    }

    document.getElementById('inviteBtn').onclick = async function() {
        const btn = this;
        const originalText = btn.textContent;

        btn.textContent = "Generating...";
        const success = await newGame(true); // Creates game with aiMode = false

        if (success && gameId) {
            playerRole = 'X';
            identityText.textContent = "YOU ARE PLAYER X";
            aiControl.style.display = 'none';

            const link = `${window.location.origin}${window.location.pathname}?gameId=${gameId}`;

            // Update Host's URL so they are officially in the "session"
            window.history.pushState({}, '', link);

            copyToClipboard(link).then(() => {
                alert("Invite link copied!");
                btn.textContent = "Link Copied!";
                setTimeout(() => btn.textContent = originalText, 3000);
            }).catch(() => {
                prompt("Could not auto-copy. Copy this link manually:", link);
                btn.textContent = originalText;
            });

            connectWebSocket(gameId);
        } else {
            btn.textContent = "Error!";
            setTimeout(() => btn.textContent = originalText, 2000);
        }
    };

    document.getElementById('newGame').onclick = () => {
        playerRole = null;
        opponentJoined = document.getElementById('aiToggle').checked;
        identityText.textContent = "";
        aiControl.style.display = 'flex';
        // Remove gameId from URL for fresh local start
        window.history.pushState({}, '', window.location.pathname);
        newGame();
    };

    rematchBtn.onclick = () => {
        if (stompClient) {
            stompClient.send(`/app/rematch/${gameId}`, {}, JSON.stringify({ player: playerRole }));
        }
    };

    cells.forEach(cell => {
        cell.onclick = () => handleMove(cell.dataset.row, cell.dataset.col);
    });

    window.onload = () => {
        const id = new URLSearchParams(window.location.search).get('gameId');
        if (id) {
            gameId = id;
            playerRole = 'O';
            identityText.textContent = "YOU ARE PLAYER O";
            aiControl.style.display = 'none';
            connectWebSocket(id);
            enableBoard();
        }
    };
</script>
</body>
</html>